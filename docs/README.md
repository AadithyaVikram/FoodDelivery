# Introduction

In this exercise you will implement RESTful services to access food delivery functionality.

Key items:

- Delete console-based user interface.
- Create web module and add dummy home page.
- Implement web-based login functionality.
- Generate RESTful API, using OpenAPI specification.
- Implement RESTful Services.
- Add exception handling to return proper result in case of errors.


# Web module

Take your **Food Delivery Persistence** solution. Copy the source files into the current repository.

Add `web` maven module.

Add the following dependencies to it:

- `org.springframework.boot:spring-boot-starter-web`
- `org.springframework.boot:spring-boot-starter-thymeleaf`
- `org.springframework.boot:spring-boot-starter-test` (test scope)

Add project dependencies: **persistence** and **service**

Exclude **application** module from the project build (remove the module reference in the parent pom.xml),
and copy the following files to **web** module.

- Main class (`ApplicationStarter`)
- `application.properties`

Use `data.sql` file that is provided in the template folder of this repository.

Add `home.html` file to `src/main/resources/template` folder
(you can find it in the template repository, in the same folder).

Add `HomeController` and a handler method that handles root request (/), it should handle HTTP GET method.
The handler method should return **"home"** (logical view name).

Test your application: navigate to http://localhost:8080

It should display the home page.

Note: it is a dummy home page, just for testing successful login and to provide logout function in the next section.


# Login functionality

Add the following dependencies to `web` module:

- `org.springframework.boot:spring-boot-starter-security`
- `org.springframework.security:spring-security-test` (test scope)

Create a class for security configuration: `com.epam.training.food.security.WebSecurityConfig`

Add the following annotations to the class: `@Configuration`, `@EnableWebSecurity`

Add HttpSecurity configuration:

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http.csrf().disable()
            .authorizeRequests()
            .anyRequest().authenticated()
            .and().formLogin().permitAll();
    return http.build();
}
```

Add security customizer:

```java
@Bean
public WebSecurityCustomizer webSecurityCustomizer() {
    return (web) -> web
            .ignoring().antMatchers("/h2-console/**", "/error");
}
```

Add password encoder:

```java
@Bean
public PasswordEncoder passwordEncoder() {
    return NoOpPasswordEncoder.getInstance();
}
```

Note:
- Do not worry about deprecated `NoOpPasswordEncoder`. In this training project it is safe to store passwords unencrypted.

Create `CustomUserDetailsService` class (name is arbitrary, up to you).

Implementation details are up to you. Make sure that:

- The class implements `UserDetailsService`.
- It is a spring bean.
- It delegates User loading to `CustomerRepository` (Create `findByUserName` method that returns `Optional<Customer>`)


## Test

Test login by navigating to http://localhost:8080

If the user provides correct credentials (as defined in `data.sql` file, *Smith/SmithSecret* for example),
the application should let the user in and display the home page.


# Api module

In this section of the exercise you will establish the foundations of RESTful service implementation
following API-first approach. The API specification is given in OpenAPI specification file.

The goal is to generate java API interfaces and model files using code generation tool (maven plugin).

API-first is the preferred approach when team members or teams collaborate with each other:

- Frontend or mobile developers with backend developers.
- API testers with backend developers.
- Service consumers (e.g. in a microservice architecture).


## OpenAPI Specification

The api module provided in the template project repository.

Please open the food delivery REST API OpenAPI specification file (`api/src/main/resources/fooddelivery.yml`)
and investigate its content.

Add **api** module to **web** module as maven dependency. 


## Source Code Generation

Add **api** module as a submodule of Food Delivery project.

Execute `mvn compile` goal in the api module and see java source files that has been generated by the openapi-generator-maven-plugin.

The generated files are placed in the following two folders:
- `src/main/java/com/epam/training/food/api`
- `src/main/java/com/epam/training/food/model`

The **model** classes has been generated from the schema types of the specification (`FoodModel`, `OrderModel`, etc).

The generator plugin creates interfaces for the java Rest Controller handler methods, 
grouped by the provided tags: **FoodService** and **OrderService**.
Based on that approach, the api package contains two interfaces:

- `FoodServiceApi`
- `OrderServiceApi`

Please make sure that you read and **understand** the signature and annotations of the generated handler methods.


## Food Service Implementation

The next task is to create `FoodController` class and implement the operations defined by `FoodServiceApi`.

- Implement `FoodServiceApi` interface.
- Inject `FoodDeliveryService` to call the relevant service methods of it.

The return type of the controller's getFoods() operation is `List<FoodModel>`,
but `FoodDeliveryService`'s `getFoods()` method returns `List<Food>`.
Create a converter class (e.g. `FoodConverter`) that performs the required conversion between these types.


## Testing the endpoint

Once the implementation is ready, it is time to test it.

### Browser

Note: the operation is defined with HTTP GET method, that's why a web browser can be used for testing.

- First navigate to http://localhost:8080 and authenticate (*Smith/SmithSecret*)
- Enter the operation address: http://localhost:8080/api/foods

## Postman

The primary tool to test RESTful API endpoints is **Postman** (or similar tool).

At first trial, Postman will not give the expected result due the missing authentication.
It will show an HTML response that contains the Login form.

To provide authentication, the browser's session can be used. Take **JSESSIONID** from the browser:

- In Chrome open Developer Tools.
- Select Application tab, Select Storage/Cookies in navigation panel.
- Find JSESSIONID and copy the value.

In Postman you can configure the cookie.

A more convenient approach is to set up login request in Postman
- http://localhost:8080/login
- POST method
- Send form data, fields: **username** and **password**

After successful authentication, Postman returns JSESSIONID in a cookie,
and automatically sends it in the next request.


# Security - REST response

As it was written in the previous section, in case of missing authentication,
the server will respond an HTML page for the user to log in.
This is a good solution for a human user, but it does not help in case of REST API call.

If the caller does not provide authentication in the call,
the server should simply return the relevant HTTP status code (and some messagwe).

To change the behaviour, an alternative Authentication EntryPoint must be configured.
Create a class (e.g. `CustomAuthenticationEntryPoint`),
implement Spring Security `AuthenticationEntryPoint` interface, and implement the `commence` method:

```java
response.setStatus(HttpStatus.UNAUTHORIZED.value());
response.getOutputStream().println("Missing authentication");
```

Change HttpSecurity configuration in `WebSecurityConfig`, add:

```java
.and().exceptionHandling()
    .defaultAuthenticationEntryPointFor(new CustomAuthenticationEntryPoint(), new AntPathRequestMatcher("/api/**"));
```

entryPoint is an instance of the custom entry point class.

Test it by calling the REST endpoint without valid session (e.g. in browser after logout).


# Error handling

If the application throws an exception, the caller would get Internal Server error.
To make it more caller friendly, map the exceptions to relevant HTTP status codes in an exception handler:

- `NoSuchElementException` -> 404
- `AccessDeniedException` -> 403
- `IllegalArgumentException` -> 400


# Implement all endpoints

Implement all the remaining endpoints. There are a few changes to apply in the service:

| method     | Description                                                                                                                                            |
|------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| `listOrders` | Get all orders which is owned by the logged in user. Add necessary method to `OrderRepository` interface.                                              |
| `getOrderById` | get order by identifier; returns `Optional<Order>`; throws `AccessDeniedException`, if the requested order is not woned by the authenticated customer. |
| `getOrders` | Returns all orders that the authenticated customer owns; Implement `findByCustomerUserName` method in `OrderRepository` to query the orders.           |

Check the implementation correctness by executing tests in `FoodDeliveryRestServiceTest`.


# Cleanup

Remove application module.
